# Changelog - Warehouse PWA Prototype

## [Unreleased] - 2024-12-05

### Крупные функциональные улучшения

#### 1. Система режимов UX (Новичок / Профессионал)
**Файлы:**
- `src/contexts/UXModeContext.tsx`
- `src/utils/userPreferences.ts`
- `src/components/UXModeToggle.tsx`

**Возможности:**
- Два режима работы: "Новичок" и "Профессионал"
- Режим "Новичок": подробные подсказки, анимации, пошаговые инструкции
- Режим "Профессионал": компактный интерфейс, потоковое сканирование по умолчанию, минимум подтверждений
- Автоматическое применение настроек при переключении режима
- Сохранение выбранного режима в localStorage

#### 2. Spotlight-поиск (Ctrl+K / Cmd+K)
**Файлы:**
- `src/components/SpotlightSearch.tsx`

**Возможности:**
- Глобальный поиск по документам, товарам и ячейкам
- Быстрый вызов через горячие клавиши Ctrl+K или Cmd+K
- Поиск в реальном времени с приоритезацией результатов
- Навигация через клавиатуру (стрелки, Enter, Escape)
- Отображение недавних документов при отсутствии запроса
- Умная категоризация результатов с иконками и подробностями

#### 3. Виджет "Моё рабочее место"
**Файлы:**
- `src/components/WorkspaceWidget.tsx`

**Возможности:**
- Отображение текущих документов в работе (до 3 штук)
- Визуализация прогресса по каждому документу
- Средний процент выполнения всех активных задач
- Быстрый переход к документам одним кликом
- Отображение времени последней активности
- Кнопка обновления виджета

#### 4. Умная система ошибок
**Файлы:**
- `src/utils/smartErrors.ts`
- `src/components/SmartErrorDialog.tsx`

**Возможности:**
- Структурированные ошибки с объяснением причины
- Предложение решения проблемы
- Действия для быстрого исправления (кнопки действий)
- Три уровня серьезности: error, warning, info
- Реестр типовых ошибок с готовыми решениями
- Фабрика действий для стандартных операций (retry, goBack, contactSupport и др.)

**Зарегистрированные ошибки:**
- `PRODUCT_NOT_FOUND` - Товар не найден
- `PRODUCT_NOT_IN_DOCUMENT` - Товар не в документе
- `CELL_NOT_FOUND` - Ячейка не найдена
- `QUANTITY_EXCEEDED` - Превышено количество
- `DOCUMENT_COMPLETED` - Документ завершён
- `NO_INTERNET` - Нет подключения
- `SYNC_FAILED` - Ошибка синхронизации
- `PERMISSION_DENIED` - Доступ запрещён
- `DUPLICATE_SCAN` - Повторное сканирование
- `INVALID_FORMAT` - Неверный формат

#### 5. Система автоматизации
**Файлы:**
- `src/utils/automation.ts`

**Возможности:**

**AutoProgressionService:**
- Автоматический переход к следующей строке после сканирования
- Настраиваемая задержка перехода (по умолчанию 500мс)

**AutoCorrectionService:**
- Определение количества по серии быстрых сканов одного товара
- Предложение корректировки количества на основе паттерна сканирования
- Порог времени для группировки сканов (по умолчанию 2 секунды)

**AutoAcceptanceService:**
- Автоматическое принятие количества при точном совпадении отсканированного и ожидаемого
- Опциональное требование подтверждения
- Логика определения намеренного действия по числу последовательных сканов

**ScanPatternAnalyzer:**
- Анализ истории сканирования (до 50 последних сканов)
- Определение режима "быстрого сканирования"
- Расчёт среднего интервала между сканами
- Предсказание времени следующего скана
- Статистика по строкам документа

**SmartDefaultsService:**
- Предсказание следующей ячейки на основе паттерна (A1-01 → A1-02)
- Предложение типичного количества для товара на основе истории

#### 6. Система персонализации
**Файлы:**
- `src/utils/userPreferences.ts`

**Возможности:**
- Отслеживание доступа к документам (последние 50)
- Учёт частоты сканирования товаров (топ 100)
- Статистика использования модулей
- Сохранение любимых шаблонов (до 20)
- Настраиваемые горячие клавиши
- Автоматическое сохранение в localStorage

**Отслеживаемые данные:**
- Недавние документы с счётчиком обращений
- Часто сканируемые товары
- Время использования модулей
- Избранные шаблоны комментариев

#### 7. Голосовая помощь без интернета
**Файлы:**
- `src/utils/voicePhrases.ts`
- `src/utils/voice.ts` (расширен)

**Возможности:**
- Работа через Web Speech API (без интернета)
- Готовые фразы для складских операций
- Настраиваемые параметры голоса (pitch, rate, volume)
- Фразы для всех типов операций: приёмка, размещение, подбор, отгрузка, инвентаризация, возврат

**Категории голосовых команд:**
- Обратная связь при сканировании (успех/ошибка)
- Навигация по ячейкам
- Подтверждение количества
- Операции с документами
- Предупреждения и ошибки
- Инвентаризация (совпадение/расхождение/излишек)
- Подбор (инструкции по позициям)
- Общие инструкции

**Быстрые команды (quickVoice):**
- `scan()` - Отсканировано
- `error()` - Ошибка
- `next()` - Следующая позиция
- `done()` - Завершено
- `wait()` - Подождите
- `ok()` - Подтверждено

#### 8. Улучшения модуля "Партнёр"
**Файлы:**
- `src/services/partnerService.ts`
- `src/components/partner/PartnerSelector.tsx`
- `src/pages/PartnerManagement.tsx`

**Возможности:**
- Фильтрация только активных смен
- Приоритетный поиск по первым буквам имени
- Автоматическое предложение напарника, с кем работали вчера
- Визуальное выделение вчерашнего напарника
- Статистика совместимости напарников

#### 9. Улучшения инвентаризации
**Файлы:**
- `src/pages/Inventory.tsx`
- `src/utils/soundEffects.ts`
- `src/hooks/useSwipe.ts`

**Возможности:**

**Режим потокового сканирования:**
- Минимальный UI без промежуточных экранов
- Компактный список последних 10 сканирований
- Автоматическое скрытие детального вида

**Звуковые сигналы:**
- Найден (800Hz) - высокий сигнал
- Не учтён (600Hz→500Hz) - два средних сигнала
- Лишний (400Hz) - низкий гудок
- Генерация через Web Audio API

**Плашка с счётчиком:**
- "Осталось просканировать N товаров"
- Градиентная анимация для привлечения внимания
- Показывается только в потоковом режиме

**Свайп для смены ячейки:**
- Свайп влево → следующая ячейка
- Свайп вправо → предыдущая ячейка
- Визуальные стрелки-подсказки
- Счётчик ячеек (1 из N)
- Минимальная дистанция свайпа: 80px

#### 10. Улучшения возврата/списания
**Файлы:**
- `src/components/return/ReasonSelector.tsx`
- `src/pages/Return.tsx`

**Возможности:**
- Крупные кнопки причин с иконками
- Автоматическое требование фото после сканирования (опционально)
- Шаблоны комментариев (6 готовых для возврата, 6 для списания)
- Кнопка "Шаблоны" с быстрым выбором
- Автофото режим с переключателем
- Категоризация причин по цветам (красный, оранжевый, жёлтый, синий, серый)

### Технические улучшения

#### Новые утилиты:
- `userPreferences.ts` - управление предпочтениями пользователя
- `smartErrors.ts` - система умных ошибок
- `automation.ts` - автоматизация рутинных операций
- `voicePhrases.ts` - голосовые фразы для склада
- `soundEffects.ts` - звуковые эффекты

#### Новые хуки:
- `useUXMode` - работа с режимом UX
- `useSpotlight` - управление Spotlight-поиском
- `useSmartError` - управление умными ошибками
- `useSwipe` - детекция жестов свайпа

#### Новые контексты:
- `UXModeContext` - глобальный режим UX

#### Новые компоненты:
- `SpotlightSearch` - глобальный поиск
- `WorkspaceWidget` - виджет рабочего места
- `SmartErrorDialog` - диалог умных ошибок
- `UXModeToggle` - переключатель режима UX
- `UXModeBadge` - бейдж текущего режима

### Улучшения UX

1. **Удалены эмодзи с кнопок** - оставлен только текст и иконки для профессионального вида
2. **Адаптивный интерфейс** - подстраивается под уровень пользователя
3. **Горячие клавиши** - Ctrl+K для глобального поиска
4. **Персонализация** - система запоминает действия пользователя
5. **Контекстные подсказки** - помощь только там, где нужно
6. **Умные ошибки** - объяснение причины и решения
7. **Голосовая обратная связь** - для шумных складов
8. **Автоматизация** - меньше действий для рутинных операций

### Производительность

- Все персонализованные данные хранятся в localStorage
- Spotlight-поиск с дебоунсом (150мс)
- Мемоизация вычислений в компонентах
- Lazy loading для диалогов и виджетов
- Оптимизированные запросы к IndexedDB

### Совместимость

- Web Speech API для голосовой помощи (современные браузеры)
- Touch events для свайпов (мобильные устройства)
- Web Audio API для звуковых эффектов
- Local Storage для персистентности
- IndexedDB для данных

### Документация

Вся новая функциональность задокументирована:
- JSDoc комментарии для всех публичных API
- Описание интерфейсов и типов
- Примеры использования в комментариях
- README обновлён

---

## Как использовать новые функции

### 1. Переключение режима UX
```typescript
import { useUXMode } from '@/contexts/UXModeContext';

const { mode, setMode, toggleMode } = useUXMode();
// mode: 'beginner' | 'professional'
setMode('professional');
```

### 2. Глобальный поиск
- Нажмите `Ctrl+K` (или `Cmd+K` на Mac)
- Начните вводить номер документа, название товара или адрес ячейки
- Используйте стрелки для навигации, Enter для выбора

### 3. Умные ошибки
```typescript
import { createError, ErrorActions } from '@/utils/smartErrors';

const error = createError('PRODUCT_NOT_FOUND', undefined, [
  ErrorActions.retry(() => rescan()),
  ErrorActions.goBack(navigate),
]);
showError(error);
```

### 4. Голосовые подсказки
```typescript
import { voiceScanned, voiceError, voiceCell } from '@/utils/voicePhrases';

voiceScanned('Молоко 3.2%');
voiceCell('A1-05');
voiceError('Товар не найден в документе');
```

### 5. Автоматизация
```typescript
import { autoProgression, scanPatternAnalyzer } from '@/utils/automation';

// Включить авто-переход
autoProgression.enable(500); // 500ms задержка

// Анализ паттерна
scanPatternAnalyzer.addScan(barcode, lineId);
if (scanPatternAnalyzer.isRapidScanning()) {
  // Пользователь в режиме быстрого сканирования
}
```

---

## Миграция

Новые функции полностью обратно совместимы. Для активации:

1. Оберните приложение в `UXModeProvider`:
```typescript
<UXModeProvider>
  <App />
</UXModeProvider>
```

2. Добавьте `SpotlightSearch` в корневой компонент:
```typescript
const spotlight = useSpotlight();
return (
  <>
    <YourApp />
    <SpotlightSearch isOpen={spotlight.isOpen} onClose={spotlight.close} />
  </>
);
```

3. Используйте `WorkspaceWidget` на главной странице:
```typescript
<WorkspaceWidget />
```

---

## Известные ограничения

1. **Web Speech API** - поддерживается не во всех браузерах (проверка через `VoiceService.isSupported()`)
2. **Touch events** - свайпы работают только на touch-устройствах
3. **Local Storage** - ограничение 5-10MB на домен

---

## Планы на будущее

- Синхронизация персонализации между устройствами
- Машинное обучение для предсказаний
- Расширенная аналитика использования
- Кастомизация голосовых фраз
- Экспорт/импорт настроек
