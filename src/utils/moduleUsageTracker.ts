/**
 * Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚ÐºÐ°Ð¼Ð¸
 * ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
 */

export interface ModuleUsageRecord {
  uni: string;
  lastUsed: number; // timestamp
  usageCount: number;
}

const STORAGE_KEY = 'module_usage_history';
const MAX_HISTORY_SIZE = 50;

/**
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
 */
export function getModuleUsageHistory(): ModuleUsageRecord[] {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return [];
    
    const history: ModuleUsageRecord[] = JSON.parse(stored);
    
    // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð½Ð¾Ð²Ñ‹Ðµ Ð¿ÐµÑ€Ð²Ñ‹Ð¼Ð¸)
    return history.sort((a, b) => b.lastUsed - a.lastUsed);
  } catch (error) {
    console.error('Failed to load module usage history:', error);
    return [];
  }
}

/**
 * Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ñ
 */
export function trackModuleUsage(uni: string): void {
  try {
    const history = getModuleUsageHistory();
    const now = Date.now();
    
    // ÐÐ°Ð¹Ñ‚Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ
    const existingIndex = history.findIndex(record => record.uni === uni);
    
    if (existingIndex >= 0) {
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
      history[existingIndex] = {
        uni,
        lastUsed: now,
        usageCount: history[existingIndex].usageCount + 1,
      };
    } else {
      // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
      history.unshift({
        uni,
        lastUsed: now,
        usageCount: 1,
      });
    }
    
    // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
    const trimmedHistory = history
      .sort((a, b) => b.lastUsed - a.lastUsed)
      .slice(0, MAX_HISTORY_SIZE);
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmedHistory));
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ UI
    window.dispatchEvent(new CustomEvent('module-usage-updated', { 
      detail: { uni, timestamp: now } 
    }));
    
    console.log(`ðŸ“Š Tracked module usage: ${uni} at ${new Date(now).toLocaleTimeString()}`);
  } catch (error) {
    console.error('Failed to track module usage:', error);
  }
}

/**
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ N Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
 */
export function getRecentModules(count: number = 3): string[] {
  const history = getModuleUsageHistory();
  return history.slice(0, count).map(record => record.uni);
}

/**
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸, Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ
 */
export function getAllModulesSortedByUsage(): string[] {
  const history = getModuleUsageHistory();
  return history.map(record => record.uni);
}

/**
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð¼Ð¾Ð´ÑƒÐ»ÑŽ
 */
export function getModuleStats(uni: string): ModuleUsageRecord | null {
  const history = getModuleUsageHistory();
  return history.find(record => record.uni === uni) || null;
}

/**
 * ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
 */
export function clearUsageHistory(): void {
  try {
    localStorage.removeItem(STORAGE_KEY);
    window.dispatchEvent(new CustomEvent('module-usage-updated'));
    console.log('ðŸ—‘ï¸ Module usage history cleared');
  } catch (error) {
    console.error('Failed to clear usage history:', error);
  }
}

/**
 * Ð¥ÑƒÐº Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð½Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
 */
export function subscribeToUsageUpdates(callback: () => void): () => void {
  const handler = () => callback();
  window.addEventListener('module-usage-updated', handler);
  
  return () => {
    window.removeEventListener('module-usage-updated', handler);
  };
}

