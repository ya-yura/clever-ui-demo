# üìë –ö–æ–Ω—Ç—Ä–∞–∫—Ç API –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É PWA-–∫–ª–∏–µ–Ω—Ç–æ–º "–°–∫–ª–∞–¥-15" –∏ Backend-—Å–µ—Ä–≤–∏—Å–æ–º —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫.

## 1. –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
*   **–ü—Ä–æ—Ç–æ–∫–æ–ª:** HTTP/1.1 (–∏–ª–∏ HTTP/2)
*   **–ú–µ—Ç–æ–¥:** `POST`
*   **–§–æ—Ä–º–∞—Ç:** JSON
*   **–ü—Ä–∏–Ω—Ü–∏–ø Offline-First:** –ö–ª–∏–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã. –°–æ–±—ã—Ç–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å UUID –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ. –°–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ —Ö—Ä–∞–Ω–∏—Ç.
*   **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –ö–ª–∏–µ–Ω—Ç –Ω–µ –∂–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è, –∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –ø–∞—á–∫–∞–º–∏ –≤ —Ñ–æ–Ω–µ.

## 2. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è API

### –≠–Ω–¥–ø–æ–∏–Ω—Ç
`POST /api/v1/analytics/batch`

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ (Headers)
```http
Content-Type: application/json
X-API-Key: <YOUR_SECRET_KEY>
User-Agent: Cleverence-PWA/1.0.0
```

### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (Request Body)
–ú–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏: 10-50 —Å–æ–±—ã—Ç–∏–π.

```json
{
  "events": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "eventType": "scan.success",
      "timestamp": 1732531200000,
      "userId": "user_123",
      "deviceId": "device_abc",
      "payload": {
        "barcode": "460123456789",
        "method": "camera",
        "duration_ms": 150,
        "scan_interval": 2300
      }
    },
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "eventType": "receiving.document.complete",
      "timestamp": 1732531500000,
      "userId": "user_123",
      "payload": {
        "documentId": "DOC-001",
        "duration_ms": 45000,
        "lines_count": 10,
        "errors_count": 0
      }
    }
  ]
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ Event
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID (string) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏. |
| `eventType` | string | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä. `scan.success`, `app.error`). |
| `timestamp` | number | Unix timestamp (–º—Å) –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. |
| `userId` | string (opt) | ID –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. |
| `deviceId` | string (opt) | ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (fingerprint). |
| `payload` | object | –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ JSON –¥–∞–Ω–Ω—ã–µ, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è. |

### –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (Response)

*   **200 OK** ‚Äî –ü–∞—á–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞.
    ```json
    {
      "success": true,
      "processed": 2,
      "failed": 0
    }
    ```
    *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:* –ï—Å–ª–∏ –≤ –ø–∞—á–∫–µ –±—ã–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã (–ø–æ `id`), —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∏—Ö –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –≤–µ—Ä–Ω—É—Ç—å 200 OK –¥–ª—è –≤—Å–µ–≥–æ –ø–∞–∫–µ—Ç–∞.

*   **400 Bad Request** ‚Äî –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JSON.
    ```json
    {
      "success": false,
      "error": "Invalid data format: 'events' must be an array"
    }
    ```

*   **401 Unauthorized** ‚Äî –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π `X-API-Key`.

*   **500 Internal Server Error** ‚Äî –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ–∑–∂–µ.

## 3. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ö–ª–∏–µ–Ω—Ç—É (PWA)

1.  **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è:**
    *   –°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î (IndexedDB) —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`.
    *   –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ñ–æ–Ω–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º.

2.  **–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏:**
    *   –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 —à—Ç).
    *   –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ 30 —Å–µ–∫).
    *   –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∏ (`window.addEventListener('online')`).

3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
    *   –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ –∏–ª–∏ 500-–º —Å—Ç–∞—Ç—É—Å–µ: —Å–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª (Exponential Backoff).
    *   –ü—Ä–∏ 400-–º —Å—Ç–∞—Ç—É—Å–µ (Bad Request): "–±–∏—Ç—ã–µ" —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ–º–µ—á–∞—Ç—å—Å—è –∫–∞–∫ `error`, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –≤–µ—á–Ω–æ.

4.  **–û—á–∏—Å—Ç–∫–∞:**
    *   –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–ø–æ–ª—É—á–µ–Ω 200 OK) —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –∏–ª–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `synced`.
    *   –°—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π) —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## 4. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –°–µ—Ä–≤–µ—Ä—É

1.  **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (–ö—Ä–∏—Ç–∏—á–Ω–æ):**
    *   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø–æ–ª—é `id`.
    *   –ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ (Upsert / On Conflict Do Nothing) –æ—à–∏–±–∫–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è.

2.  **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
    *   `payload` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ JSONB (PostgreSQL) –∏–ª–∏ Document (MongoDB) –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≥–∏–±–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
    *   –î–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è `serverReceivedAt` ‚Äî –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–º (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–¥–µ—Ä–∂–µ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏).

3.  **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
    *   –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ JSON (—Å—Ö–µ–º—ã Zod/Joi).
    *   Rate Limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç DDoS).

## 5. –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π: –†–∞–±–æ—Ç–∞ –≤ Offline
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ –±–µ–∑ Wi-Fi 2 —á–∞—Å–∞.
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è 500 —Å–æ–±—ã—Ç–∏–π (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥—ã).
3. –í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–µ–∂–∞—Ç –≤ IndexedDB.
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –≤ –∑–æ–Ω—É Wi-Fi.
5. Service Worker –∏–ª–∏ `useSync` —Ö—É–∫ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å–µ—Ç—å.
6. –ö–ª–∏–µ–Ω—Ç –±–µ—Ä–µ—Ç –ø–µ—Ä–≤—ã–µ 50 —Å–æ–±—ã—Ç–∏–π –∏ —à–ª–µ—Ç `POST`.
7. –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç 200 OK.
8. –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—è–µ—Ç —ç—Ç–∏ 50 —Å–æ–±—ã—Ç–∏–π –∏ —à–ª–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ 50.

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å (–î—É–±–ª–∏–∫–∞—Ç—ã)
1. –ö–ª–∏–µ–Ω—Ç —à–ª–µ—Ç –ø–∞—á–∫—É –∏–∑ 10 —Å–æ–±—ã—Ç–∏–π.
2. –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î.
3. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 200 OK, –Ω–æ —Å–µ—Ç—å –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º.
4. –ö–ª–∏–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å (timeout/network error).
5. –ß–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –∫–ª–∏–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–π –∂–µ –ø–∞—á–∫–∏.
6. –°–µ—Ä–≤–µ—Ä –≤–∏–¥–∏—Ç –∑–Ω–∞–∫–æ–º—ã–µ `id`, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤—Å—Ç–∞–≤–∫—É, –Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç 200 OK.
7. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç 200 OK –∏ —É—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç—Å—è.


