# üöÄ Supabase Analytics Setup

–ú—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É **Supabase Edge Functions** –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ Node.js —Å–µ—Ä–≤–µ—Ä–∞. –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–µ–∫—É Lovable –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ—Å—à–æ–≤–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.

## 1. –°—Ö–µ–º–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

SQL —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω –≤ `supabase/migrations/20240320_create_activity_events.sql`.

**–¢–∞–±–ª–∏—Ü–∞ `activity_events`:**
- `id` (UUID) - Primary Key
- `event_type` (Text)
- `timestamp` (BigInt)
- `payload` (JSONB) - –•—Ä–∞–Ω–∏—Ç –ª—é–±—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- `user_id`, `device_id`

## 2. Edge Function

–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ `supabase/functions/analytics-batch/index.ts`.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ **Deno** (TypeScript)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Zod** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–µ–≥–æ JSON
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Service Role Key** –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–ø–∏—Å—å —Å —Å–µ—Ä–≤–µ—Ä–∞)
- ‚úÖ –†–µ–∞–ª–∏–∑—É–µ—Ç `upsert` (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ ID)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç CORS

## 3. –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ Supabase (–∏–ª–∏ —á–µ—Ä–µ–∑ CLI Lovable, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ):

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
supabase db push

# 2. –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
supabase functions deploy analytics-batch

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
supabase secrets set SUPABASE_URL=... SUPABASE_SERVICE_ROLE_KEY=...
```

## 4. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

–í —Ñ–∞–π–ª–µ `src/analytics.ts` –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å `endpoint`:

```typescript
analytics.init({
  // URL –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ Supabase
  endpoint: 'https://<PROJECT_ID>.supabase.co/functions/v1/analytics-batch',
  // ...
});
```


