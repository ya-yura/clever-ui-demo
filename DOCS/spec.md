# Склад-15 PWA — Developer-Ready Specification

## 1. Назначение и область применения
Мобильный PWA-клиент для системы Cleverence «Склад-15» позволяет сотрудникам склада работать с документами (приёмка, размещение, подбор, отгрузка, возвраты, инвентаризация и др.) в онлайн/оффлайн режимах. Приложение должно корректно работать на стандартной теме и на интерфейсах/скинах, собранных в Creator.

## 2. Функциональные требования
0. **Setup и первичная конфигурация**
   - Экран `/setup` открывается при первом запуске или после сброса настроек.
   - Пользователь обязан указать базовый URL API (по умолчанию `http://localhost:9000/MobileSMARTS/api/v1/`), проверить соединение и сохранить настройки.
   - После успешной конфигурации приложение перенаправляет на `/login`. Кнопка «Изменить сервер» на экране логина должна возвращать пользователя на `/setup`, очищая сохранённые токены и кеш API.
1. **Авторизация**
   - Экран логина — главный и единственный путь входа.
   - Блоки: форма логина/пароля, первичная кнопка «Войти», вторичная кнопка «Войти без авторизации» (демо), поле изменения URL сервера.
   - Поддержка OAuth2 (`/.well-known/openid-configuration`, `/connect/token`), временного токена (`?tempuid=`), демо-режима без бэкенда.
2. **Главный экран**
   - Плитки операций (DocTypes) подгружаются с `/api/v1/DocTypes`. Ответ соответствует контракту `ODataDocumentType` (см. раздел «Работа с данными»).
   - Счётчики документов:
     - Приоритетный путь — `GET /api/v1/Docs/{DocType.uni}/$count` с заголовком `Accept: text/plain`, результаты приводятся к числу.
     - При недоступности `$count` выполняется `GET /api/v1/Docs/{DocType.uni}` постранично (`$top=100`, `$skip`), суммируется `value.length`.
     - Если API недоступно, используется кэш `IndexedDB` (`documentCounter`), а при его отсутствии — mock‑данные.
3. **Список документов**
   - Универсальные фильтры («все», «новые», «в работе», «выполнены», …) соответствуют дизайну chip-компонентов.
   - Переход в список конкретного типа `/docs/:docTypeUni`.
   - Просмотр карточки документа `/docs/:docTypeUni/:docId`.
4. **Модули складских операций**
   - Приёмка, Размещение, Подбор, Отгрузка, Возврат, Инвентаризация.
   - Сканирование (hook `useScanner`), обработка линий, прогресс, авто-завершение, обратная связь (`feedback` utils).
5. **Оффлайн и синхронизация**
   - IndexedDB через Dexie (`db.ts`).
   - Очередь `syncActions`, авто-синхронизация (`useSync`).
6. **Настройки и вспомогательные страницы**
   - Партнёр, Настройки, Статистика, Диагностика, Обратная связь, О программе.
7. **Документация и поддержка скинов**
   - Любые изменения UI не должны ломать сторонние интерфейсы Creator (динамическая загрузка схемы через `DynamicGridInterface`).

## 3. Нефункциональные требования
- PWA: оффлайн кэш, установка, работа в браузерах Chromium/Android.
- Темы: светлая/тёмная (`ThemeProvider`, `data-theme`).
- UX: плоские линейные иконки, акценты по бренд-палитре.
- Дев-сервер через Vite, proxy на `http://localhost:9000/MobileSMARTS/api/v1/`.
- Документация хранится в `DOCS/`.

## 4. Архитектура
| Слой | Описание |
|------|----------|
| **UI (React + TS, Tailwind)** | Компоненты страниц, карточек, плиток, фильтров. Контекст `DocumentHeaderContext` управляет заголовками. |
| **Контексты** | `AuthContext` (токены, `checkNoAuth`, login/logout), `ThemeContext`, `MenuProvider`. |
| **Сервисы** | `api.ts` (Axios клиент, baseURL, proxy), `authService.ts`, `documentService.ts` (объединяет OData и IndexedDB), `odataCache.ts`, `documentCounter.ts`, `schemaLoader.ts`. |
| **Hooks** | `useScanner`, `useOfflineStorage`, `useSync`, `useReferences`. |
| **Данные** | IndexedDB (Dexie tables), локальные JSON-заглушки (fallback). |
| **Навигация** | React Router: публичные маршруты `/setup`, `/login`, защищённые под `ProtectedRoute`. |

## 5. Работа с данными
1. **DocTypes и Docs**
   - Контракт DocType (`ODataDocumentType`):
     - Обязательные поля: `id`, `uni`, `name`, `displayName`, `buttonColor`, флаги (`clientCreating`, `manualDocumentSelection`, `barcodeDocumentSelection`).
     - Необязательные: `alias`, `filePath`, `visible`, `enabled`, `customCss`, `imageFileId`.
   - Контракт документа (`ODataDocument`):
     - Обязательные поля: `id`, `name`, `documentTypeName`, `createDate`, `lastChangeDate`, `priority`, `status flags (inProcess, finished, notOpenedYet)`.
     - Необязательные: `userId`, `userName`, `warehouseId`, `description`.
   - Кэш `odataCache` хранит:
     - `ALL_DOCS_CACHE_KEY` — объединённый список всех документов (пагинация требуется).
     - `DOCS_BY_TYPE:{docTypeUni}` — список документов конкретного типа.
   - Алгоритм загрузки:
     1. Попытаться взять данные из кэша (валидность ≤5 минут).
     2. При отсутствии — запросить `/Docs` с `$skip`/`$top`. Пустой ответ → fallback на `/Docs/{docType}`.
     3. Все ответы сериализуются в IndexedDB (таблицы `receivingDocuments`, `pickingDocuments`, и т.д.).
   - `documentService` объединяет `ODataDocument` + локальные документы Dexie → `UniversalDocument`. Поля типа `docTypeUni`, `origin` обязательны для трекинга источника.
2. **Документы операций**
   - Contracts:
     - ReceivingLine: `id`, `documentId`, `productId`, `productName`, `barcode`, `quantityPlan`, `quantityFact`, `status`, `expiryDate?`.
     - PlacementLine: дополнительно `cellId`, `suggestedCellId`, `placedAt`.
     - PickingLine: `routeOrder`, `cellId`, `pickedAt`.
     - ShipmentLine: `packageId`, `ttn?`, `ttnNumber?`.
     - InventoryLine: `cellId`, `quantitySystem`, `discrepancy`.
   - Порядок загрузки: IndexedDB → API (`get{Module}Document`) → сохранение в Dexie → отображение.
   - Обновления:
     - Все изменения линий через Dexie и `addSyncAction`.
     - Документ получает `completedLines`, `updatedAt` при каждом изменении.
3. **Авторизация**
   - `configService` хранит базовый URL.
   - `authService` управляет токенами в `localStorage`, проверяет `.well-known`, умеет демо-режим.
4. **Скин Creator**
   - Конфигурации в `localStorage` (SchemaLoader), UI строится через `DynamicGridInterface`.

## 6. Стратегия обработки ошибок
- **API уровень**
  - Все вызовы проходят через `api.client` (Axios). Для сетевых/5xx ошибок: повтор через экспоненциальный backoff (2 попытки) и показ тоста «Нет соединения».
  - При `401/403`: очищаем токены (`authService.clearTokens()`), редирект на `/login`, показываем сообщение «Сессия истекла».
  - При ошибке `$count`/DocTypes → логируем `console.warn`, переходим к fallback.
- **Сканеры**
  - `QRScanner`: ошибки доступа к камере показываются в модальном блоке (красный баннер), при закрытии выводим подсказку повторить попытку.
  - `useScanner`: события «нет кода» игнорируются, прочие ошибки бросают `feedback.error`.
- **IndexedDB**
  - Любой `Dexie.DexieError` приводит к: лог в `errorLogs`, уведомление пользователю («Ошибка локальной базы. Попробуйте перезапустить»). Если таблица недоступна — переключаемся на in-memory массив.
- **Sync**
  - Очередь `syncActions` хранит `error` и `retryCount`.
  - При недоступности сети: badge «офлайн», кнопка «Синхронизировать» disabled.
  - При фатальной ошибке (4xx) запись помечается `error`, пользователь получает уведомление с инструкцией повторить вручную.
- **UI/UX**
  - Важные действия (завершение документа, смена ячейки, удаление линии) сопровождаются `confirm`.
  - Все тосты/баннеры должны иметь текст на русском и иконку статуса.

## 7. План тестирования
1. **Авторизация + Setup**
   - Успешный сценарий: `Setup` → смена URL → логин OAuth.
   - Неверный URL (сервер недоступен) → сообщение об ошибке.
   - `tempuid` → мгновенный вход.
   - Демо-режим при активном требовании авторизации (кнопка работает, но отображается предупреждение).
2. **DocTypes и главные плитки**
   - `$count` возвращает строку → корректно конвертируется.
   - API возвращает пустой массив → fallback на `/Docs/{docType}`.
   - API недоступно → отображается данные из Dexie, пользователь предупреждён.
   - Проверить пагинацию (`$skip/$top`), суммарное количество > 100.
3. **Списки документов**
   - Чипы меняют фильтр, цвета соответствуют теме.
   - Навигация `/docs/:docTypeUni`, `/docs/:docTypeUni/:docId`.
4. **Модули операций**
   - Сканирование валидного штрихкода, неверного, повторного (уведомление).
   - Авто-завершение документа обновляет статус, создаёт `SyncAction`.
   - Создание документа из предыдущего этапа (приёмка → размещение, подбор → отгрузка).
5. **Синхронизация/оффлайн**
   - Очередь действий пополняется в офлайне.
   - После восстановления сети `sync()` очищает очередь, badge обновляется.
   - Конфликт (сервер вернул 409) → запись в `errorLogs`, пользователь предупреждён.
6. **Темы/скины**
   - Светлая/тёмная тема: проверка плиток, кнопок, фильтров.
   - Установка кастомного интерфейса Creator (через QR/файл), загрузка `DynamicGridInterface`.
7. **PWA**
   - Установка на устройство, работа без сети (DocTypes из Dexie).
   - Обновление Service Worker и уведомление об обновлении.

## 8. Требования к документированию
- Любые изменения должны отражаться в соответствующих файлах `DOCS/`.
- При добавлении новых модулей — расширяйте spec, prompt план и todo.

